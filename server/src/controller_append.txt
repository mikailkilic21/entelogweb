
exports.getRecentChecks = async (req, res) => {
    try {
        const config = getConfig();
        const firm = config.firmNo || '113';
        const period = config.periodNo || '01';
        const cscardTable = `LG_${firm}_${period}_CSCARD`;

        const query = `
            SELECT TOP 10
                C.LOGICALREF as id,
                C.NEWSERINO as serialNo,
                C.DUEDATE as dueDate,
                C.AMOUNT as amount,
                C.CURRSTAT as status,
                C.BANKNAME as bankName
            FROM ${cscardTable} C
            WHERE C.DOC = 1
            ORDER BY C.LOGICALREF DESC
        `;

        const result = await sql.query(query);
        const checks = result.recordset.map(c => ({
            ...c,
            dueDate: c.dueDate ? c.dueDate.toISOString().split('T')[0] : null,
            statusLabel: (c.status === 1) ? 'Portföyde' : (c.status === 8 ? 'Ödendi' : 'İşlemde')
        }));

        res.json(checks);

    } catch (err) {
        console.error('❌ getRecentChecks Error:', err.message);
        res.status(500).json({ error: err.message });
    }
};
